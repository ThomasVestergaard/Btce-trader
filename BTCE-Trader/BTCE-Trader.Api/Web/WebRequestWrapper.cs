using System;
using System.Collections.Generic;
using System.IO;
using System.Net;
using System.Security.Cryptography;
using System.Text;
using System.Web;
using BTCE_Trader.Api.Configurations;
using log4net;

namespace BTCE_Trader.Api.Web
{
    public class WebRequestWrapper : IWebRequestWrapper
    {
        private static readonly ILog Logger = LogManager.GetLogger(typeof(WebRequestWrapper));

        private IConfiguration configuration { get; set; }
        private HMACSHA512 keyHasher { get; set; }
        private long sequenceIncrementer;
        private long requestSequenceNumber
        {
            get
            {
                long seq = (long) (DateTime.Now.Subtract(new DateTime(1970, 1, 1))).TotalSeconds + sequenceIncrementer + 10000;
                sequenceIncrementer++;
                return seq;
            }
        }

        public WebRequestWrapper(IConfiguration configuration)
        {
            this.configuration = configuration;
            sequenceIncrementer = 0;
            keyHasher = new HMACSHA512(Encoding.ASCII.GetBytes(configuration.SecretKey));
        }

        public string RequestData(string method, Dictionary<string, string> postArguments)
        {
            postArguments.Add("method", method);
            postArguments.Add("nonce", requestSequenceNumber.ToString());
            var dataStr = BuildPostData(postArguments);
            var data = Encoding.ASCII.GetBytes(dataStr);

            var request = WebRequest.Create(new Uri("https://btc-e.com/tapi")) as HttpWebRequest;
            if (request == null)
                throw new Exception("Non HTTP WebRequest");

            request.Method = "POST";
            request.Timeout = 15000;
            request.ContentType = "application/x-www-form-urlencoded";
            request.ContentLength = data.Length;

            request.Headers.Add("Key", configuration.PublicKey);
            request.Headers.Add("Sign", BitConverter.ToString(keyHasher.ComputeHash(data)).Replace("-", "").ToLower());
            var reqStream = request.GetRequestStream();
            
            reqStream.Write(data, 0, data.Length);
            
            string toReturn = new StreamReader(request.GetResponse().GetResponseStream()).ReadToEnd();
            reqStream.Close();
            return toReturn;
        }

        public string RequestV3(string method, string parameters)
        {

            //return "{\"ltc_btc\":{\"asks\":[[0.02699,0.92838716],[0.02701,0.1],[0.02702,0.1],[0.02703,0.1],[0.02706,104.33587537],[0.02707,0.1],[0.02708,100.41782648],[0.02709,87.24020342],[0.0271,102.45497298],[0.02711,16.16767186],[0.02712,286.43032558],[0.02713,8.35065666],[0.02714,167.08359469],[0.02715,16.03614372],[0.02716,2.7],[0.02717,33.20217],[0.02718,22.66381732],[0.02719,1.9618497],[0.0272,56.54715499],[0.02721,11.63175],[0.02722,12.72893581],[0.02723,2.91956],[0.02724,9.4],[0.02725,20.810176],[0.02726,5.93167848],[0.02727,6],[0.02728,5.03884905],[0.02729,16.58595466],[0.0273,14.8852047],[0.02731,24.07047756],[0.02732,18.23393007],[0.02733,1.41956],[0.02734,20.66938],[0.02735,8.09242273],[0.02736,1.1667815],[0.02737,0.486],[0.02738,24.95364262],[0.02739,1.9627207],[0.0274,3.794],[0.02741,1.5994791],[0.02742,0.68289],[0.02743,4.83234307],[0.02744,0.5],[0.02745,2.27664],[0.02746,1.3],[0.02748,87.34179361],[0.02749,19.27666028],[0.0275,99.03540091],[0.02751,0.69854],[0.02752,4.0399397],[0.02753,2],[0.02755,93.24566498],[0.02756,1.372],[0.02757,34.1],[0.02759,1086.20692845],[0.0276,1035.13769853],[0.02761,2],[0.02762,1.5],[0.02763,0.2],[0.02764,0.6],[0.02765,6.3897977],[0.02766,0.3],[0.02767,0.3],[0.02768,76.2208316],[0.02769,176.778913],[0.0277,425.50765524],[0.02771,10.12284334],[0.02772,8.82536769],[0.02773,0.6],[0.02774,209.41543585],[0.02775,65.50768811],[0.02776,1.8],[0.02777,13.60768584],[0.02778,19.00223272],[0.02779,42.18291026],[0.0278,12.29525301],[0.02781,47.94189975],[0.02782,100],[0.02783,466.2],[0.02784,1078.6],[0.02785,408.2],[0.02786,1.2],[0.02787,0.17733462],[0.02788,29.39732492],[0.02789,81.38296733],[0.0279,9.8871954],[0.02791,253.94402027],[0.02792,0.1],[0.02793,20.76334385],[0.02794,120.18245738],[0.02795,209.44695396],[0.02796,4.04357472],[0.02797,106.67143506],[0.02798,329.87709895],[0.02799,468.6420977],[0.028,2128.95140929],[0.02801,76.4024],[0.02802,5],[0.02803,0.10566292],[0.02804,0.1],[0.02805,44.70929025],[0.02806,0.99550769],[0.02807,155],[0.02808,492.34504311],[0.02809,225],[0.0281,2079.22957705],[0.02811,101.98724992],[0.02812,0.7],[0.02813,1.306],[0.02814,9.98],[0.02815,40.31693096],[0.02816,155.2],[0.02817,300],[0.02818,0.6],[0.02819,368.51870386],[0.0282,1044.43939635],[0.02821,44.13853159],[0.02822,298.4361212],[0.02823,102.42691066],[0.02824,0.1],[0.02825,89.67068365],[0.02826,1.61337648],[0.02827,333.02664088],[0.02828,66.15674397],[0.02829,310],[0.0283,2740.46584337],[0.02831,91.55436304],[0.02832,1.749],[0.02833,165.9816305],[0.02835,27.09567238],[0.02836,27.39839102],[0.02837,0.24294207],[0.02838,0.4],[0.02839,102.56584033],[0.0284,105.84365],[0.02841,0.2],[0.02842,2.18306605],[0.02843,11.23050655],[0.02844,200],[0.02845,2.1188055],[0.02846,0.7],[0.02847,9.6203],[0.02848,49.45145742],[0.02849,24.20087489],[0.0285,1815.22206119],[0.02851,215.47826919],[0.02852,1.78127058],[0.02853,4.684018],[0.02854,20.10644335],[0.02855,0.4]],\"bids\":[[0.02695,0.5],[0.02694,1.84947022],[0.02689,0.1569],[0.02688,90.00319597],[0.02687,2.53219],[0.02686,1],[0.02684,2.9191887],[0.02683,0.2569],[0.02682,48.62291083],[0.02681,43.408],[0.0268,2.31306371],[0.02679,96.1664803],[0.02678,1.1569],[0.02675,24.51477448],[0.02673,5.14070531],[0.02671,24.202],[0.0267,6.71876546],[0.02669,20.88644553],[0.02668,0.93488633],[0.02667,4],[0.02666,86.25327522],[0.02665,90.94559127],[0.02664,0.22306],[0.02662,0.23],[0.02661,12.2445],[0.0266,87.99963803],[0.02658,1.76163],[0.02657,5.69091833],[0.02656,210.14024199],[0.02655,103.26194521],[0.02654,144.29523],[0.02653,38.60581747],[0.02652,49.56220219],[0.02651,382.14409455],[0.0265,1850.94763989],[0.02649,1.01095206],[0.02648,60.4222],[0.02647,0.1],[0.02646,12.38359182],[0.02645,17.98958081],[0.02644,0.99432603],[0.02643,50.375],[0.02642,35.28427972],[0.02641,11.47520682],[0.0264,618.4238561],[0.02639,22.96131298],[0.02638,36.26],[0.02637,5.2],[0.02636,5.3],[0.02635,5.2],[0.02634,25.69055609],[0.02633,10.72428095],[0.02632,5],[0.02631,5.2],[0.0263,54.3],[0.02629,5],[0.02628,15],[0.02627,5.1],[0.02626,5.1],[0.02625,38.2],[0.02624,96.8501],[0.02623,5.1],[0.02622,60.50864951],[0.02621,17.912],[0.0262,8.10531593],[0.02619,5.3],[0.02618,7.37222],[0.02617,5.2],[0.02616,6.2081],[0.02615,52.86608915],[0.02614,5.57520682],[0.02613,5.1],[0.02612,126.60548277],[0.02611,784.38],[0.0261,1271.79729331],[0.02609,105],[0.02608,1005],[0.02607,56.55740792],[0.02606,5.3],[0.02605,6.1],[0.02604,5],[0.02603,6.832],[0.02602,185.1],[0.02601,584.9995],[0.026,1427.61002145],[0.02599,12.45],[0.02598,15.84908766],[0.02597,8.32588127],[0.02596,5.2],[0.02595,5.2],[0.02594,5.1],[0.02593,5.12258336],[0.02592,5],[0.02591,36.57],[0.0259,17.12376921],[0.02589,84.099],[0.02588,5.65633],[0.02587,5.1],[0.02586,5.1],[0.02585,6.97],[0.02584,5.2],[0.02583,5],[0.02582,30],[0.02581,5.10980787],[0.0258,113.44172474],[0.02579,20],[0.02578,5.4],[0.02577,5],[0.02576,5.1],[0.02575,5.2],[0.02574,5.1],[0.02573,5],[0.02572,5],[0.02571,6.998],[0.0257,44],[0.02569,5],[0.02568,7.41],[0.02567,625],[0.02566,376.3],[0.02565,13.03344],[0.02564,5],[0.02563,5],[0.02562,31],[0.02561,17.38],[0.0256,124.89823818],[0.02559,5],[0.02558,5.20105],[0.02557,10.1666667],[0.02556,12.5],[0.02555,105.3],[0.02554,5.4],[0.02553,105],[0.02552,29],[0.02551,25.314],[0.0255,75.78325936],[0.02549,5],[0.02548,5.1],[0.02547,5.2],[0.02546,5.4],[0.02545,5.1],[0.02544,5.1],[0.02543,5],[0.02542,6.70331275],[0.02541,160.25640667],[0.0254,2475],[0.02539,5.3],[0.02538,6],[0.02536,5.6],[0.02535,5.5293],[0.02534,5]]},\"btc_usd\":{\"asks\":[[609.619,8.02129897],[609.8,0.14023974],[610.51,0.02],[611.5,0.01],[611.7,0.01],[612,2.994],[613.049,0.04193956],[613.167,0.02],[613.6,0.01],[614,1],[614.051,0.45464415],[614.119,0.09842676],[614.945,6.51768213],[614.946,9.76092055],[614.99,1.99],[615,0.04600643],[615.046,0.01],[615.9,0.7],[616,1],[616.074,0.04869869],[616.5,1],[616.8,0.18745348],[616.98,0.01996],[616.99,0.75],[617,10.0696],[617.826,0.01],[618,1.15327849],[618.056,0.0201616],[618.203,0.01],[618.557,0.44334012],[619,2],[619.047,1.0493867],[619.2,0.2],[619.96,22.6],[619.966,0.52972137],[620,10.63938699],[620.129,0.08677],[620.24,0.33],[620.302,0.01],[620.303,0.02],[620.417,0.05869127],[620.492,0.02],[620.666,0.0394],[621.109,7.19073115],[621.195,0.01000994],[621.98,3.47314791],[622,0.61],[622.115,0.01],[622.21,0.2],[622.6,0.21684815],[622.67,1.12878758],[623,1.5369],[623.94,0.01],[623.999,0.01353287],[624,2.61572173],[624.052,0.05],[624.1,0.01],[624.484,0.01],[624.88,0.2079],[624.89,0.40527914],[625,2.01490715],[625.021,0.017],[625.045,0.3428273],[625.1,0.04],[625.11,0.01],[625.155,0.01],[625.29,0.2],[625.4,0.05],[625.485,0.05],[625.709,0.017],[625.8,0.01642795],[625.803,0.05],[625.805,0.05],[625.889,0.05],[625.9,0.58466018],[626,0.83766953],[626.398,0.027],[626.428,0.01],[626.446,0.01],[626.457,0.01000994],[626.5,0.01],[626.605,1.6],[627,2.60016116],[627.087,0.017],[627.13,0.01],[627.23,0.01],[627.45,0.01],[627.666,0.01],[627.68,0.0998],[627.745,0.193],[627.777,0.017],[627.786,78.1],[627.798,0.09575],[627.8,25],[627.9,0.01],[627.96,0.1],[628,2.4272],[628.144,0.01],[628.22,0.0998],[628.43,0.01],[628.468,0.017],[628.7,0.0706817],[629,4.6368],[629.16,0.017],[629.52,0.1015],[629.7,0.7],[629.852,0.017],[629.9,0.02],[629.99,0.05389921],[629.999,0.011],[630,13.76555555],[630.1,0.1],[630.3,0.0330587],[630.359,0.011],[630.411,2.4],[630.44,0.17090655],[630.5,0.2],[630.543,0.01996],[630.545,0.017],[630.708,0.01],[630.898,0.1],[630.9,0.01],[631,0.3355],[631.239,0.017],[631.764,0.01000994],[631.9,0.25],[631.934,0.017],[632,0.250776],[632.227,0.01],[632.46,0.01],[632.629,3.99926006],[632.938,0.02797156],[632.98,0.15519522],[632.99,0.0185],[632.997,1.32],[632.998,0.03],[632.999,21.3],[633,6.79478214],[633.101,0.29195174],[633.325,0.017],[633.44,0.01],[633.547,0.01],[633.62,0.01],[633.64,0.01],[633.67,0.01],[633.88,0.01],[633.891,0.02],[634,0.5586],[634.023,0.016],[634.15,4.94579761]],\"bids\":[[609.615,0.694836],[609.119,0.01],[608.84,0.2],[608.05,0.1],[608,14.90208646],[607.77,5.45757],[607.5,0.02],[607.3,0.01],[607.2,0.795],[607.12,0.01],[607.119,0.01],[607.118,0.01],[607.1,19.33077],[607,1.35036882],[606.931,0.01003],[606.151,0.05580307],[606.11,0.03],[606.1,0.0684523],[606.051,0.05],[606.01,0.3],[606,0.56919051],[605.003,11.53907945],[605.002,6.77272143],[605.001,0.07037926],[605,50.20794364],[604.99,0.01],[604.522,0.01003],[604.51,0.26971683],[604.145,0.6639393],[604.06,0.01],[604,16.84337808],[603.78,3.9916132],[603.664,0.84855619],[603.53,0.01],[603.485,5],[603.306,0.25],[603.245,0.14810159],[603.069,0.057999],[603,12.7325],[602.694,0.1698],[602.65,0.01],[602.535,0.01],[602.5,4],[602.45,3.3476],[602.2,0.03],[602.16,0.0166068],[602.069,0.0202369],[602.001,14.57078075],[602,24.33284913],[601.999,0.4],[601.931,0.1],[601.9,0.2],[601.777,0.04278718],[601.7,16.07666406],[601.61,0.01],[601.57,0.01],[601.531,0.044],[601.5,1],[601.3,0.27467249],[601.234,1.66523288],[601.23,0.099],[601.14,0.43387292],[601.112,7.1],[601.111,10],[601.1,2.35],[601.09,3.007],[601.069,0.027057],[601.029,0.01002004],[601.01,10],[601.003,0.0772],[601.001,4],[601,18.8623104],[600.8,1],[600.68,0.01],[600.6,0.01],[600.56,0.01],[600.51,5],[600.49,0.01],[600.466,0.02253903],[600.44,1.5],[600.344,0.020469],[600.3,0.03634187],[600.15,0.20503774],[600.12,0.011],[600.101,14.2],[600.1,0.7321147],[600.03,4.409],[600.02,3.02],[600.019,1.5],[600.011,0.1],[600.01,21.39],[600.001,1.29901921],[600,79.98603906],[599.916,0.383],[599.592,0.02101],[599.5,0.1],[599.4,0.01],[599.27,0.01],[599.239,0.0109725],[599.02,0.01],[599,10.72973248],[598.803,0.01],[598.69,0.26],[598.5,0.01],[598.485,0.01],[598.001,0.17329412],[598,6.85599088],[597.5,0.01],[597.401,0.01],[597.081,0.014],[597.04,0.01],[597,2.0419],[596.71,0.01],[596.58,0.01],[596.51,0.9388],[596.5,0.01],[596.076,0.01599],[596,0.2229],[595.999,0.01],[595.5,5.11],[595.1,0.25],[595.001,22.3],[595,27.0517725],[594.729,0.01002004],[594.5,0.01],[594.449,0.02],[594,0.0546],[593.989,0.15],[593.88,0.01],[593.76,1.07426665],[593.7,0.01],[593.564,0.0128],[593.5,5.01],[593.216,0.02004],[593,3.1097],[592.989,0.15],[592.4,0.11116542],[592.388,0.01],[592.16,0.0168873],[592.123,0.029069],[592,5.25502659],[591.99,7.1],[591.989,0.15896812],[591.5,7.17951757],[591.401,0.10176],[591.3,3.195],[591.076,0.18802559],[591.001,28.4],[591,37.3452],[590.999,0.01]]},\"ltc_usd\":{\"asks\":[[16.549999,23.01921484],[16.55,434.95053941],[16.629898,1],[16.6299,207.320602],[16.63,85.41864241],[16.64,259.78],[16.64999,0.12728933],[16.65,333.49476292],[16.66,0.6],[16.665,0.25670823],[16.67,5],[16.676745,0.2],[16.67982,0.73587],[16.68998,7],[16.69,1.3],[16.69871,0.3],[16.698997,0.3],[16.698998,0.9],[16.699,8.18323959],[16.69993,0.3],[16.7,208.73721724],[16.70328,0.39061],[16.70676,0.17477955],[16.707441,0.3],[16.71,1.2],[16.716,0.7216],[16.717593,1.03683969],[16.73,8.584],[16.733,1],[16.7351,0.3],[16.74,32.38],[16.749,0.3],[16.74983,2.18011834],[16.74999,0.3],[16.75,324.49074858],[16.750201,0.6],[16.751,0.1],[16.7511,0.6],[16.75121,0.3],[16.754,0.2],[16.756478,0.3],[16.756745,0.3],[16.76,19.101],[16.761001,0.3],[16.763,0.5],[16.766,0.6],[16.767,0.3],[16.77,101.6],[16.771,0.5],[16.778,1],[16.78,0.5],[16.781,1],[16.783,0.5],[16.784,0.5],[16.784018,0.5],[16.7841,0.5],[16.78533,0.55634],[16.787662,72],[16.79,88.69043521],[16.791,0.1],[16.79328,30],[16.8,141.59868172],[16.803017,0.3],[16.806,0.5],[16.80992,0.3],[16.81,1.104],[16.82,0.2],[16.83,0.3],[16.833,1.67179283],[16.839,1],[16.84,28.58395375],[16.841,0.3],[16.842,0.3],[16.849,0.3],[16.849579,0.3],[16.84983,0.6],[16.84999,0.3],[16.85,0.3],[16.854,7.888],[16.856658,3.37968],[16.87,35.63667795],[16.878,0.3],[16.88,0.9],[16.881,0.3],[16.881998,2.5],[16.882,0.5],[16.883,0.5],[16.883997,19.998999],[16.887998,2584.86483834],[16.888,673],[16.889,10],[16.88979,31.63534659],[16.89,31.09],[16.893,0.5],[16.893001,0.5],[16.899,19.71810663],[16.8999,0.1748496],[16.89999,1.57804969],[16.9,361.54776955],[16.9001,0.3],[16.901,0.1],[16.903017,0.48973182],[16.90658,0.5],[16.91,26.80854727],[16.91144,0.1],[16.92,0.3],[16.920001,0.1],[16.9261,0.1498],[16.9265,62.53975748],[16.929,0.1],[16.92997,0.3],[16.93,1],[16.936491,100],[16.938997,42.67863231],[16.93992,0.3],[16.93997,0.6],[16.94,23.15126],[16.9433,0.45],[16.943628,0.5],[16.9499,0.3],[16.94999,16.32810575],[16.949999,400],[16.95,202.39061177],[16.9501,0.4],[16.9599,0.6],[16.96,359.81154457],[16.9601,1.5],[16.9602,0.3],[16.963,0.5],[16.96505,0.9],[16.969999,600],[16.97,614.23274465],[16.9702,0.9],[16.97992,5.37048847],[16.98,129.3371],[16.9802,1.2],[16.981,7.2754],[16.989,0.1],[16.9899,90.719],[16.989999,400],[16.99,245.71412583],[16.991,12.82541051],[16.998,9.234],[16.9988,1.3487989],[16.999,13.42781891],[16.99999,1],[17,2571.35340499],[17.005,0.1],[17.006,0.4],[17.007478,0.15138652]],\"bids\":[[16.501015,218.10410257],[16.47001,12.75092153],[16.47,59.92],[16.461,72.60154149],[16.46,68.3622686],[16.45042,10],[16.45,45.04],[16.44,0.3],[16.42,8.26758579],[16.41,36.74203584],[16.403769,50.56194955],[16.401015,0.9],[16.40001,2.01182097],[16.4,220.2],[16.397,0.5],[16.39,0.6],[16.388998,0.3],[16.38,17.84],[16.377628,0.5],[16.368,0.5],[16.367,1.62926762],[16.36699,0.5],[16.362,0.5],[16.34058,0.5],[16.33709,0.3],[16.3321,2],[16.327,0.5],[16.32282,0.14483],[16.32,20.81],[16.316,0.5],[16.315998,1.5],[16.310001,221.93707735],[16.31,497.43998002],[16.303,3.93478622],[16.3001,20],[16.30001,3],[16.3,1126.4492556],[16.299,0.2],[16.295,270],[16.29,25.8],[16.28972,0.3],[16.289,2],[16.2886,0.3],[16.285997,2],[16.28,123.73938683],[16.27998,0.5],[16.27,0.5],[16.268,0.3],[16.2623,0.1501],[16.251,10],[16.25001,71.00605],[16.25,809.45364908],[16.249,0.5],[16.248991,0.5],[16.2351,0.10199],[16.23,35.07085642],[16.22,7.99174722],[16.21636,349.127],[16.210001,400],[16.21,259.84578779],[16.205,1.792],[16.20432,3],[16.203,0.3],[16.201,150.2],[16.20001,311.4],[16.2,384.85000695],[16.19,24],[16.189,0.2],[16.187,0.2],[16.185999,0.2],[16.18531,10],[16.184,20.14152558],[16.18,61],[16.1777,100],[16.177,0.2],[16.17001,273.62865596],[16.17,1],[16.168468,5.871235],[16.167,20],[16.16,3.57975526],[16.1599,5.4],[16.15,12.24706],[16.14999,498.10861059],[16.14,1],[16.139,143.99729782],[16.13,1],[16.1216,0.113],[16.12121,193.36257534],[16.12,76.92659513],[16.1188,151.39009252],[16.112,19.3],[16.1111,8.87714819],[16.111,50],[16.11,61.37515531],[16.105671,1000],[16.10567,3467.24097853],[16.104,561],[16.1029,1.096],[16.101,82.83],[16.1,4335.95643176],[16.09991,631.97860898],[16.099,12.6408],[16.09,141.99532203],[16.088,114],[16.081,0.2],[16.08,28.86585665],[16.079,3.02087173],[16.075762,3.65031],[16.07,1518.45],[16.05668,122],[16.05123,10.03],[16.05,107.50259723],[16.04581,0.18197897],[16.03887,0.11687108],[16.03,7.58491621],[16.02321,50],[16.021,0.2341],[16.020001,400],[16.02,407.76806414],[16.016366,34.9642],[16.014,300],[16.012,35.77491817],[16.011,220.20814595],[16.01001,43.9],[16.01,857.71374674],[16.005,9.28881667],[16.002,3],[16.0012,5],[16.0011,10],[16.001001,400],[16.001,1299.13308729],[16.00005,100],[16.00001,254.78704485],[16,7896.89631627],[15.995,0.594],[15.99,33.75846695],[15.98133,3306.61510587],[15.97329,25.06508055],[15.961,0.5],[15.95,1272.01657793],[15.949702,5.96802],[15.94,573.5715],[15.92,12],[15.91,10],[15.9001,20],[15.900001,200],[15.9,6646.16040121],[15.891,5.23193708],[15.89,10.5],[15.8889,31.7]]}}";
            string url = string.Format("https://btc-e.com/api/3/{0}/{1}?ignore_invalid=0", method, parameters);
            var request = WebRequest.Create(url);
            request.Proxy = WebRequest.DefaultWebProxy;
            request.Proxy.Credentials = System.Net.CredentialCache.DefaultCredentials;
            if (request == null)
                throw new Exception("Non HTTP WebRequest");
            return new StreamReader(request.GetResponse().GetResponseStream()).ReadToEnd();
        }

        private string BuildPostData(Dictionary<string, string> arguments)
        {
            StringBuilder s = new StringBuilder();
            foreach (var item in arguments)
            {
                s.AppendFormat("{0}={1}", item.Key, HttpUtility.UrlEncode(item.Value));
                s.Append("&");
            }
            if (s.Length > 0) s.Remove(s.Length - 1, 1);
            return s.ToString();
        }

        

    }
}
